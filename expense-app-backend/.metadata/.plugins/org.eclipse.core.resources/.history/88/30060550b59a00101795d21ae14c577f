package com.example.expenseshare.controller;

import com.example.expenseshare.dto.CreateExpenseRequest;
import com.example.expenseshare.model.Expense;
import com.example.expenseshare.model.ExpenseShare;
import com.example.expenseshare.model.User;
import com.example.expenseshare.repository.ExpenseRepository;
import com.example.expenseshare.repository.ExpenseShareRepository;
import com.example.expenseshare.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.*;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api")
@CrossOrigin(origins = "http://localhost:5173")
public class ExpenseController {

    @Autowired
    private ExpenseRepository expenseRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private ExpenseShareRepository expenseShareRepository;

    @GetMapping("/expenses")
    public List<Expense> getAllExpenses() {
        return expenseRepository.findAll();
    }

    @PostMapping("/expenses")
    @Transactional
    public ResponseEntity<Expense> createExpense(@RequestBody CreateExpenseRequest request) {
        // 1. Find the user who paid for the expense
        User paidBy = userRepository.findById(request.getPaidById())
                .orElseThrow(() -> new RuntimeException("User who paid not found with ID: " + request.getPaidById()));

        // 2. Create and save the main Expense entity
        Expense expense = new Expense();
        expense.setDescription(request.getDescription());
        expense.setAmount(request.getAmount());
        expense.setPaidBy(paidBy);
        Expense savedExpense = expenseRepository.save(expense);

        // --- 3. Splitting Logic ---
        List<User> participants = new ArrayList<>();
        participants.add(paidBy); // The payer is always included in the split

        // Find the other users who the expense is shared with
        if (request.getSharedWithIds() != null && !request.getSharedWithIds().isEmpty()) {
            List<User> sharedWithUsers = userRepository.findAllById(request.getSharedWithIds());
            participants.addAll(sharedWithUsers);
        }

        // Remove duplicates in case the payer's ID was also in the sharedWithIds list
        List<User> distinctParticipants = participants.stream().distinct().collect(Collectors.toList());

        int totalParticipants = distinctParticipants.size();
        if (totalParticipants == 0) {
            // This case should not happen if the payer is always added, but it's a good safeguard
            throw new RuntimeException("Expense must have at least one participant.");
        }

        // Calculate the amount each person owes
        BigDecimal shareAmount = request.getAmount().divide(new BigDecimal(totalParticipants), 2, RoundingMode.HALF_UP);

        // 4. Create an ExpenseShare record for each participant
        List<ExpenseShare> shares = new ArrayList<>();
        for (User participant : distinctParticipants) {
            shares.add(new ExpenseShare(savedExpense, participant, shareAmount));
        }

        // 5. Save all the share records to the database
        expenseShareRepository.saveAll(shares);
        savedExpense.setShares(shares);

        return new ResponseEntity<>(savedExpense, HttpStatus.CREATED);
    }
}
